<t-loading [loadingState]="pageState">
  <ng-container *ngIf="show$ | async as show">
    <ng-container *ngIf="{ value: showWatched$ | async } as showWatchedContext">
      <ng-container *ngIf="{ value: tmdbShow$ | async } as tmdbShowContext">
        <t-show-header
          [tmdbSeason]="tmdbSeason$ | async"
          [posterPrefix]="posterPrefix"
          [showWatched]="showWatchedContext.value"
          [tmdbShow]="tmdbShowContext.value"
          [show]="show"
          [isFavorite]="isFavorite$ | async"
          [isSmall]="isSmall"
          (addFavorite)="showService.addFavorite($event)"
          (removeFavorite)="showService.removeFavorite($event)"
        ></t-show-header>

        <ng-container *ngIf="{ value: showProgress$ | async } as showProgressContext">
          <ng-container *ngIf="nextEpisode$ | async as nextEpisode">
            <div class="next-episode">
              <ng-container *ngIf="nextEpisode[0] !== null">
                <h3 class="mat-subheading-2 next-text">
                  Next episode
                  <span *ngIf="showProgressContext.value || tmdbShowContext.value" class="subtitle">
                    <ng-container
                      *ngIf="
                        tmdbShowContext.value &&
                        (!showProgressContext.value || showProgressContext.value.completed === 0)
                      "
                    >
                      · {{ tmdbShowContext.value.number_of_episodes }} episodes
                    </ng-container>
                    <ng-container
                      *ngIf="
                        showProgressContext.value &&
                        showProgressContext.value.completed > 0 &&
                        showProgressContext.value.aired - showProgressContext.value.completed
                      "
                    >
                      ·
                      {{ showProgressContext.value.aired - showProgressContext.value.completed }}
                      remaining
                    </ng-container>
                  </span>
                </h3>

                <t-episode
                  *ngIf="show && tmdbShowContext.value"
                  [show]="show"
                  [episode]="nextEpisode[0]"
                  [tmdbEpisode]="nextEpisode[1]"
                  [episodeProgress]="nextEpisode[2]"
                  [isSeenLoading]="(seenLoading | async) === state.LOADING"
                  (add)="addToHistory($event, show, tmdbShowContext.value)"
                ></t-episode>
              </ng-container>

              <h3
                class="mat-subheading-2"
                *ngIf="
                  showWatchedContext.value &&
                  nextEpisode[0] === null &&
                  !(tmdbShowContext.value | isShowEnded)
                "
              >
                No next episode.
              </h3>
            </div>
          </ng-container>

          <mat-list *ngIf="showProgressContext.value">
            <a
              *ngFor="let seasonProgress of showProgressContext.value.seasons"
              class="link"
              matRipple
              tHideRippleOnScroll
              [routerLink]="['season', seasonProgress.number]"
            >
              <mat-list-item>
                <t-season-item [seasonProgress]="seasonProgress"></t-season-item>
              </mat-list-item>
            </a>
          </mat-list>

          <mat-list *ngIf="tmdbShowContext.value && !showProgressContext.value">
            <a
              *ngFor="let season of tmdbShowContext.value.seasons"
              class="link"
              matRipple
              tHideRippleOnScroll
              [routerLink]="['season', season.season_number]"
            >
              <mat-list-item>
                <t-season-item [season]="season"></t-season-item>
              </mat-list-item>
            </a>
          </mat-list>
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>
</t-loading>
